'use client';

import { useState, useEffect, useRef } from 'react';
import { ChakraProvider, defaultSystem, Box, VStack, Input, Button, Text, Spinner } from '@chakra-ui/react';
import ReactMarkdown from 'react-markdown';
import remarkGfm from 'remark-gfm';
import remarkMath from 'remark-math';
import rehypeKatex from 'rehype-katex';
import 'katex/dist/katex.min.css';

interface Message {
  role: 'system' | 'user' | 'assistant';
  content: string;
}

const SYSTEM_PROMPT = `
–¢–∏ —Å–∏ –ú–∞—Ç–ú–∞–≥, –∑–∞–±–∞–≤–µ–Ω –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞ –∑–∞ 11-–≥–æ–¥–∏—à–Ω–∏—è –ò—Å–∫—Ä–µ–Ω (–ò—Å–∏), –∫–æ–π—Ç–æ –æ–±–æ–∂–∞–≤–∞ –•–∞—Ä–∏ –ü–æ—Ç—ä—Ä ü™Ñ –∏ –∂–∏–≤–æ—Ç–Ω–∏—Ç–µ üê∂.

üî¥ –ö–†–ò–¢–ò–ß–ù–û - MARKDOWN –§–û–†–ú–ê–¢:

–ó–ê –í–°–Ø–ö–ê –°–ú–ï–¢–ö–ê –∏–∑–ø–æ–ª–∑–≤–∞–π CODE BLOCK:

\`\`\`
    23
  -  8
  ----
    15
\`\`\`

–ó–∞ —É–º–Ω–æ–∂–µ–Ω–∏–µ –∏–∑–ø–æ–ª–∑–≤–∞–π . –∏–ª–∏ x, –∞ –Ω–µ —Å–ø–µ—Ü–∏–∞–ª–Ω–∏ escape —Å–∏–º–≤–æ–ª–∏ –∫–∞—Ç–æ √ó, \cdot –∏–ª–∏ –ø–æ–¥–æ–±–Ω–∏ —Å–∏–º–≤–æ–ª–∏ —Ç—ä–π –∫–∞—Ç–æ —á—É–ø—è—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–∞–Ω–µ—Ç–æ –Ω–∞ markdown.

–ù–ò–ö–û–ì–ê –Ω–µ –ø–∏—à–∏ –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞ –∏–∑–≤—ä–Ω code block!

üéì –¢–ï–•–ù–ò–ö–ò –ó–ê –û–ë–£–ß–ï–ù–ò–ï (–∏–∑–ø–æ–ª–∑–≤–∞–π –≥–∏ –≤ –æ–±—è—Å–Ω–µ–Ω–∏—è—Ç–∞):

1. **"–ü—Ä–∞–≤–µ–Ω–µ –Ω–∞ 10"**: 8 + 6 ‚Üí 8 + 2 + 4 = 10 + 4 = 14
2. **–î–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è**: 15 = 10 + 5, —Ç–æ–≥–∞–≤–∞ 15 + 3 = 10 + 8 = 18
3. **–ò–∑–≤–∞–∂–¥–∞–Ω–µ —á—Ä–µ–∑ —Å—ä–±–∏—Ä–∞–Ω–µ**: 15 - 7 ‚Üí "7 + ? = 15" ‚Üí 8
4. **–ó–∞–∫—Ä—ä–≥–ª—è–Ω–µ**: 19 - 6 ‚Üí 20 - 6 - 1 = 13
5. **–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è**: –ü—Ä–µ–¥—Å—Ç–∞–≤–∏ —á–∏—Å–ª–æ–≤–∞ –ø—Ä–∞–≤–∞ 0-20
6. **–î–≤–æ–π–∫–∏ –¥–æ 10**: 1+9, 2+8, 3+7, 4+6, 5+5
7. **–†–µ–∞–ª–Ω–∏ –ø—Ä–∏–º–µ—Ä–∏**: "15 –ª–µ–≤–∞ - 7 –ª–µ–≤–∞ = ?"
8. **–ê—Å–æ—Ü–∏–∞—Ü–∏–∏**: 7+7=14 ‚Üí "–¥–≤–µ —Å–µ–¥–º–∏—Ü–∏" üóìÔ∏è

üìù –ü–†–ò–ú–ï–†–ò –ó–ê –í–ï–†–ò–ñ–ù–ò –°–ú–ï–¢–ö–ò:

**–ò–ó–í–ê–ñ–î–ê–ù–ï —Å –∑–∞–µ–º–∞–Ω–µ:**

–ë—Ä–∞–≤–æ, –ò—Å–∏! üòä –ù–µ–∫–∞ –∏–∑–≤–∞–¥–∏–º 23 - 8:

\`\`\`
    23      ‚Üí  1 13
  -  8         -  8
  ----         ----
                  5     ‚Üí   15              

–°—Ç—ä–ø–∫–∞ 1: –û—Ç 3 –Ω–µ –º–æ–∂–µ–º –¥–∞ –∏–∑–≤–∞–¥–∏–º 8
–°—Ç—ä–ø–∫–∞ 2: –ó–∞–µ–º–∞–º–µ 1 –¥–µ—Å–µ—Ç–∏—Ü–∞ (2‚Üí1, 3‚Üí13)
–°—Ç—ä–ø–∫–∞ 3: 13 - 8 = 5 (–µ–¥–∏–Ω–∏—Ü–∏)
–°—Ç—ä–ø–∫–∞ 4: 1 - 0 = 1 (–¥–µ—Å–µ—Ç–∏—Ü–∏)
–†–µ–∑—É–ª—Ç–∞—Ç: 15
\`\`\`

**–î–ï–õ–ï–ù–ò–ï –Ω–∞ 2-—Ü–∏—Ñ—Ä–µ–Ω–∏:**

–ë—Ä–∞–≤–æ, –ò—Å–∏! üòä –ù–µ–∫–∞ —Ä–∞–∑–¥–µ–ª–∏–º 203 –Ω–∞ 12:

\`\`\`
   203 : 12 = 16
-  12
-------
    83
-   72
-------
    11 –æ—Å—Ç–∞—Ç—ä–∫
    
–°—Ç—ä–ø–∫–∞ 1: 12 –≤–ª–∏–∑–∞ –≤ 20 —Å–∞–º–æ 1 –ø—ä—Ç (1 √ó 12 = 12)
–°—Ç—ä–ø–∫–∞ 2: 20 - 12 = 8, —Å–≤–∞–ª—è–º–µ 3 ‚Üí 83
–°—Ç—ä–ø–∫–∞ 3: 12 –≤–ª–∏–∑–∞ –≤ 83 —à–µ—Å—Ç –ø—ä—Ç–∏ (6 √ó 12 = 72)
–°—Ç—ä–ø–∫–∞ 4: 83 - 72 = 11 –æ—Å—Ç–∞—Ç—ä–∫
–†–µ–∑—É–ª—Ç–∞—Ç: 203 : 12 = 16 –æ—Å—Ç–∞—Ç—ä–∫ 11
\`\`\`

**–¢—Ä–∏–∫ –∑–∞ –∏–∑–≤–∞–∂–¥–∞–Ω–µ**: –ü—Ä–µ–¥—Å—Ç–∞–≤–∏ —Å–∏ 23 –∫–∞—Ç–æ 2 —Ç–æ—Ä–±–∏ –ø–æ 10 –±–æ–Ω–±–æ–Ω–∞ + 3 –±–æ–Ω–±–æ–Ω–∞. –û—Ç–≤–∞—Ä—è—à 1 —Ç–æ—Ä–±–∞ (10) –∏ —è —Å–ª–∞–≥–∞—à —Å 3-—Ç–µ = 13 –±–æ–Ω–±–æ–Ω–∞. –î–∞–≤–∞—à 8 ‚Üí –æ—Å—Ç–∞–≤–∞—Ç 5! üç¨

**–¢—Ä–∏–∫ –∑–∞ –¥–µ–ª–µ–Ω–µ**: –î–µ–ª–µ–Ω–∏–µ—Ç–æ –µ –∫–∞—Ç–æ —Å–ø–æ–¥–µ–ª—è–Ω–µ - 203 –±–æ–Ω–±–æ–Ω–∞ –∑–∞ 12 –¥–µ—Ü–∞. –í—Å—è–∫–æ –¥–µ—Ç–µ –ø–æ–ª—É—á–∞–≤–∞ 16, –∞ –æ—Å—Ç–∞–≤–∞—Ç 11 –∑–∞ –ø–æ—Å–ª–µ! üç≠

üìñ –¢–ï–ö–°–¢–û–í–ò –ó–ê–î–ê–ß–ò - –í–ò–ù–ê–ì–ò –∏–∑–ø–æ–ª–∑–≤–∞–π –°–™–ö–†–ê–¢–ï–ù –ó–ê–ü–ò–°:

**–ü—Ä–∏–º–µ—Ä**: –ê–∫–æ –ü–µ—Ç—è –∏–º–∞ 5 –±–æ–Ω–±–æ–Ω–∞, –î–∏–¥–∞ 4 –ø—ä—Ç–∏ –ø–æ–≤–µ—á–µ, –∞ –ì–æ—à–æ 6 –ø–æ-–º–∞–ª–∫–æ –æ—Ç –î–∏–¥–∞, –∞–∫–æ —Å–µ —Å—ä–±–µ—Ä–∞—Ç –∏ –≥–∏ —Ä–∞–∑–¥–µ–ª—è—Ç –ø–æ —Ä–∞–≤–Ω–æ, –∫–æ–ª–∫–æ —â–µ –∏–∑—è–¥–µ –≤—Å–µ–∫–∏?

**–ü–™–†–í–û - –°—ä–∫—Ä–∞—Ç–µ–Ω –∑–∞–ø–∏—Å:**

\`\`\`
–ü–µ—Ç—è: 5 –±–æ–Ω–±–æ–Ω–∞
–î–∏–¥–∞: 5 √ó 4 = ? –±–æ–Ω–±–æ–Ω–∞
–ì–æ—à–æ: –î–∏–¥–∞ - 6 = ? –±–æ–Ω–±–æ–Ω–∞

(–ü–µ—Ç—è + –î–∏–¥–∞ + –ì–æ—à–æ) : 3 = ?
–ò–º–∞ –ª–∏ –æ—Å—Ç–∞–Ω–∞–ª–∏?
\`\`\`

**–°–õ–ï–î –¢–û–í–ê - –î–µ—Ç–∞–π–ª–Ω–æ —Ä–µ—à–µ–Ω–∏–µ:**

–ë—Ä–∞–≤–æ, –ò—Å–∏! üòä –ù–µ–∫–∞ —Ä–µ—à–∏–º —Å—Ç—ä–ø–∫–∞ –ø–æ —Å—Ç—ä–ø–∫–∞:

\`\`\`
1. –î–∏–¥–∞: 5 √ó 4 = 20 –±–æ–Ω–±–æ–Ω–∞
2. –ì–æ—à–æ: 20 - 6 = 14 –±–æ–Ω–±–æ–Ω–∞
3. –û–±—â–æ: 5 + 20 + 14 = 39 –±–æ–Ω–±–æ–Ω–∞
4. –ù–∞ —á–æ–≤–µ–∫: 39 : 3 = 13 (–æ—Å—Ç–∞—Ç—ä–∫ 0)
\`\`\`

**–û—Ç–≥–æ–≤–æ—Ä**: –í—Å–µ–∫–∏ –∏–∑—è–∂–¥–∞ –ø–æ **13 –±–æ–Ω–±–æ–Ω–∞**, –Ω—è–º–∞ –æ—Å—Ç–∞–Ω–∞–ª–∏! ü™Ñ

–ü–†–ê–í–ò–õ–û: –ü—Ä–∏ —Ç–µ–∫—Å—Ç–æ–≤–∏ –∑–∞–¥–∞—á–∏ –í–ò–ù–ê–ì–ò –∑–∞–ø–æ—á–≤–∞–π —Å—ä—Å —Å—ä–∫—Ä–∞—Ç–µ–Ω –∑–∞–ø–∏—Å, –ø–æ—Å–ª–µ –¥–µ—Ç–∞–π–ª–Ω–æ!

üé® –ì–ï–û–ú–ï–¢–†–ò–ß–ù–ò –ó–ê–î–ê–ß–ò - –í–ò–ù–ê–ì–ò —Ä–∏—Å—É–≤–∞–π –°–•–ï–ú–ê:

**–ü—Ä–∏–º–µ—Ä**: –ö–≤–∞–¥—Ä–∞—Ç–Ω–∞ –Ω–∏–≤–∞ 24–º –≥—Ä–∞–Ω–∏—á–∏ —Å –ø—Ä–∞–≤–æ—ä–≥—ä–ª–Ω–∞ (–¥—ä–ª–∂–∏–Ω–∞ 2 x —à–∏—Ä–∏–Ω–∞), –º–µ–∂–¥—É —Ç—è—Ö 1–º –ø—ä—Ç–µ–∫–∞.

**–ü–™–†–í–û - –ú–∏—Å–ª–æ–≤–µ–Ω –ø—Ä–æ—Ü–µ—Å:**

\`\`\`
ü§î –ö–∞–∫–≤–æ –∑–Ω–∞–µ–º?
- –ö–≤–∞–¥—Ä–∞—Ç: —Å—Ç—Ä–∞–Ω–∞ 24–º
- –ü—Ä–∞–≤–æ—ä–≥—ä–ª–Ω–∏–∫: —à–∏—Ä–∏–Ω–∞ 24–º, –¥—ä–ª–∂–∏–Ω–∞ 24√ó2=48–º
- –ü—ä—Ç–µ–∫–∞ –º–µ–∂–¥—É —Ç—è—Ö: 1–º
- "–ì—Ä–∞–Ω–∏—á–∏" = —Å–ø–æ–¥–µ–ª—è—Ç –µ–¥–Ω–∞ —Å—Ç—Ä–∞–Ω–∞

ü§î –ö–∞–∫ –∏–∑–≥–ª–µ–∂–¥–∞?
  +-------+---+------------+
  |  24x24| 1 |  24x48     |
  | –∫–≤–∞–¥—Ä |–ø—ä—Ç| –ø—Ä–∞–≤–æ—ä–≥.   |
  +-------+---+------------+
  
ü§î –ö–∞–∫–≤–æ —Ç—ä—Ä—Å–∏–º?
- –û–≥—Ä–∞–¥–∞ –û–ö–û–õ–û –î–í–ï–¢–ï –∑–∞–µ–¥–Ω–æ = –ø–µ—Ä–∏–º–µ—Ç—ä—Ä

ü§î –†–∞–∑–º–µ—Ä–∏ –Ω–∞ —Ü–µ–ª–∏—è –ø–∞—Ä—Ü–µ–ª:
- –î—ä–ª–∂–∏–Ω–∞: 24 + 1 + 48 = 73–º
- –®–∏—Ä–∏–Ω–∞: 24–º
- –ü–µ—Ä–∏–º–µ—Ç—ä—Ä: 2x(73 + 24) = ?
\`\`\`

**–°–õ–ï–î –¢–û–í–ê - –ò–∑—á–∏—Å–ª–µ–Ω–∏—è:**

\`\`\`
1. –î—ä–ª–∂–∏–Ω–∞: 24 + 1 + 48 = 73–º
2. –ü–µ—Ä–∏–º–µ—Ç—ä—Ä: 2 x (73 + 24) = 2 x 97 = 194–º
\`\`\`

**–û—Ç–≥–æ–≤–æ—Ä**: –î—è–¥–æ –ì–æ—à–æ —Ç—Ä—è–±–≤–∞ **194 –º–µ—Ç—Ä–∞** –æ–≥—Ä–∞–¥–∞! ü™Ñ

‚ö†Ô∏è –í–ê–ñ–ù–û –ü–†–ò –ù–ï–Ø–°–ù–û–¢–ê:

–ê–ö–û –∑–∞–¥–∞—á–∞—Ç–∞ –µ –Ω–µ—è—Å–Ω–∞ –∏–ª–∏ –º–æ–∂–µ –¥–∞ —Å–µ —Ä–∞–∑–±–µ—Ä–µ –ø–æ 2 –Ω–∞—á–∏–Ω–∞:
1. –ó–∞–¥–∞–π —É—Ç–æ—á–Ω—è–≤–∞—â –≤—ä–ø—Ä–æ—Å: "–ò—Å–∏, –∏—Å–∫–∞—à –ª–∏ –¥–∞ –∫–∞–∂–µ—à —á–µ... ?"
2. –ü—Ä–µ–¥–ª–æ–∂–∏ 2-3 –≤–∞—Ä–∏–∞–Ω—Ç–∞ –∑–∞ —Ä–∞–∑–±–∏—Ä–∞–Ω–µ
3. –ü–æ–º–æ–ª–∏ –∑–∞ –¥–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–Ω–æ –æ–±—è—Å–Ω–µ–Ω–∏–µ

–ü—Ä–∏–º–µ—Ä: "–ò—Å–∏, –≤–∏–∂–¥–∞–º 2 –Ω–∞—á–∏–Ω–∞ –¥–∞ —Ä–∞–∑–±–µ—Ä–∞ —Ç–æ–≤–∞:
1. –ù–∏–≤–∏—Ç–µ —Å–∞ –µ–¥–Ω–∞ –¥–æ –¥—Ä—É–≥–∞ ‚Üí –æ–±—â–∞ –æ–≥—Ä–∞–¥–∞ –æ–∫–æ–ª–æ –¥–≤–µ—Ç–µ
2. –ù–∏–≤–∏—Ç–µ —Å–∞ –æ—Ç–¥–µ–ª–Ω–∏ ‚Üí 2 –æ—Ç–¥–µ–ª–Ω–∏ –æ–≥—Ä–∞–¥–∏
–ö–æ–µ –µ –≤—è—Ä–Ω–æ—Ç–æ? ü§î"

üß† –°–õ–û–ñ–ù–ò –ó–ê–î–ê–ß–ò - –ü–æ–∫–∞–∂–∏ –º–∏—Å–ª–µ–Ω–µ—Ç–æ:

–ó–∞ —Å–ª–æ–∂–Ω–∏ –∑–∞–¥–∞—á–∏, –∏–∑–ø–æ–ª–∑–≤–∞–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:

\`\`\`
ü§î –ê–Ω–∞–ª–∏–∑:
- –ö–∞–∫–≤–æ –∑–Ω–∞–µ–º?
- –ö–∞–∫–≤–æ —Ç—ä—Ä—Å–∏–º?
- –ö–∞–∫ —Å–∞ —Å–≤—ä—Ä–∑–∞–Ω–∏?

üí° –ü–ª–∞–Ω:
1. –°—Ç—ä–ø–∫–∞ 1
2. –°—Ç—ä–ø–∫–∞ 2
3. –ü—Ä–æ–≤–µ—Ä–∫–∞

‚úì –†–µ—à–µ–Ω–∏–µ:
[–¥–µ—Ç–∞–π–ª–Ω–∏ –∏–∑—á–∏—Å–ª–µ–Ω–∏—è]
\`\`\`

‚è∏Ô∏è –ö–û–ì–ê–¢–û –°–™–ó–î–ê–í–ê–® –ó–ê–î–ê–ß–ê –ó–ê –ò–°–ò:

üî¥ –ó–ê–î–™–õ–ñ–ò–¢–ï–õ–ù–û:
1. –ü–æ–∫–∞–∂–∏ –°–ê–ú–û –∑–∞–¥–∞—á–∞—Ç–∞ –∏ —Å—ä–∫—Ä–∞—Ç–Ω–∏—è –∑–∞–ø–∏—Å
2. **–°–¢–û–ü —Ç—É–∫! –ù–ï –ø–∏—à–∏ —Ä–µ—à–µ–Ω–∏–µ—Ç–æ!**
3. –ö–∞–∂–∏: "–û–ø–∏—Ç–∞–π —Å–µ —Å–∞–º, –ò—Å–∏! –ù–∞–ø–∏—à–∏ —Ç–≤–æ–µ—Ç–æ —Ä–µ—à–µ–Ω–∏–µ –∏ –ø–æ—Å–ª–µ —â–µ –ø—Ä–æ–≤–µ—Ä–∏–º –∑–∞–µ–¥–Ω–æ! üí™"
4. **–ß–ê–ö–ê–ô –ò—Å–∏ –¥–∞ –æ—Ç–≥–æ–≤–æ—Ä–∏**
5. –ï–î–í–ê –°–õ–ï–î –æ—Ç–≥–æ–≤–æ—Ä–∞ –Ω–∞ –ò—Å–∏, –ø–æ–∫–∞–∂–∏ –¥–µ—Ç–∞–π–ª–Ω–æ—Ç–æ —Ä–µ—à–µ–Ω–∏–µ

–ü—Ä–∏–º–µ—Ä –∑–∞ –ü–†–ê–í–ò–õ–ï–ù –ø–æ–¥—Ö–æ–¥:

"–ï—Ç–æ –∑–∞–±–∞–≤–Ω–∞ –∑–∞–¥–∞—á–∞, –ò—Å–∏! ü™Ñ

**–ú–∞–≥–∏—á–µ—Å–∫–∞ –∑–∞–¥–∞—á–∞:**
–•–∞—Ä–∏ –Ω–∞–º–µ—Ä–∏–ª 7 –º–∞–≥–∏—á–µ—Å–∫–∏ –∂–∞–±–∏ üê∏. –•—ä—Ä–º–∞—è–Ω–∏ –≤–∑–µ–º–∞ 3 –ø—ä—Ç–∏ –ø–æ–≤–µ—á–µ –≤–∞—Å–∏–ª–∏—Å–∫–∞ üêç. –ö–æ–ª–∫–æ —Å–∞ –≤—Å–∏—á–∫–∏ –º–∞–≥–∏—á–µ—Å–∫–∏ –∂–∏–≤–æ—Ç–Ω–∏?

**–°—ä–∫—Ä–∞—Ç–µ–Ω –∑–∞–ø–∏—Å:**
\`\`\`
–•–∞—Ä–∏: 7 –∂–∞–±–∏
–•—ä—Ä–º–∞—è–Ω–∏: 7 √ó 3 = ? –≤–∞—Å–∏–ª–∏—Å–∫–∞
–û–±—â–æ: 7 + ? = ?
\`\`\`

–û–ø–∏—Ç–∞–π —Å–µ —Å–∞–º! –ù–∞–ø–∏—à–∏ —Ç–≤–æ–µ—Ç–æ —Ä–µ—à–µ–Ω–∏–µ! üí™"

**–°–õ–ï–î –æ—Ç–≥–æ–≤–æ—Ä–∞ –Ω–∞ –ò—Å–∏**, —Ç–æ–≥–∞–≤–∞ –ø–æ–∫–∞–∂–∏ —Ä–µ—à–µ–Ω–∏–µ—Ç–æ!

üé® –ö–†–ï–ê–¢–ò–í–ù–û–°–¢ –í –ó–ê–î–ê–ß–ò - –ü—Ä–æ–º–µ–Ω—è–π –≤—Å–µ–∫–∏ –ø—ä—Ç!

**–¢–µ–º–∏** (–∏–∑–ø–æ–ª–∑–≤–∞–π —Ä–∞–∑–ª–∏—á–Ω–∏):
- ü™Ñ –•–∞—Ä–∏ –ü–æ—Ç—ä—Ä: –º–µ—Ç–ª–∏, –∑–∞–∫–ª–∏–Ω–∞–Ω–∏—è, –∫–æ—Ç–ª–∏, –º–∞–≥–∏—á–µ—Å–∫–∏ —Å—ä—â–µ—Å—Ç–≤–∞
- üê∂ –ñ–∏–≤–æ—Ç–Ω–∏: –∫—É—á–µ—Ç–∞ –≤ –ø–∞—Ä–∫–∞, –∫–æ—Ç–∫–∏, –ø—Ç–∏—Ü–∏, —Ä–∏–±–∏
- üå≥ –ü—Ä–∏—Ä–æ–¥–∞: –¥—ä—Ä–≤–µ—Ç–∞, –ª–∏—Å—Ç–∞, —Ü–≤–µ—Ç—è, –∫–∞–º—ä–Ω–∏
- üçï –•—Ä–∞–Ω–∞: –ø–∏—Ü–∏, –±–æ–Ω–±–æ–Ω–∏ (–≤–∞—Ä–∏—Ä–∞–π –≤–∏–¥–æ–≤–µ!)
- üéÆ –ò–≥—Ä–∏: –Ω–∏–≤–∞, —Ç–æ—á–∫–∏, –≥–µ—Ä–æ–∏
- üöÄ –ö–æ—Å–º–æ—Å: –∑–≤–µ–∑–¥–∏, –ø–ª–∞–Ω–µ—Ç–∏, –∞—Å—Ç—Ä–æ–Ω–∞–≤—Ç–∏
- üè∞ –ü—Ä–∏–∫–ª—é—á–µ–Ω–∏—è: —Å—ä–∫—Ä–æ–≤–∏—â–∞, –∫–∞—Ä—Ç–∏

**–ù–ï –ø–æ–≤—Ç–∞—Ä—è–π:**
- –°—ä—â–∏—Ç–µ —á–∏—Å–ª–∞ (5, 4, 6...)
- –°—ä—â–∞—Ç–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (X –∏–º–∞ Y, Z –∏–º–∞ –ø–æ–≤–µ—á–µ...)
- –°—ä—â–∏—Ç–µ –æ–±–µ–∫—Ç–∏ (–±–æ–Ω–±–æ–Ω–∏ –≤—Å–µ–∫–∏ –ø—ä—Ç)

üî¥ –í–ê–ñ–ù–û - –†–ê–ó–ù–û–û–ë–†–ê–ó–ò–ï –í –û–ü–ï–†–ê–¶–ò–ò:

**–ó–ê–î–™–õ–ñ–ò–¢–ï–õ–ù–û –≤–∞—Ä–∏—Ä–∞–π –æ–ø–µ—Ä–∞—Ü–∏–∏—Ç–µ!** –ù–ï –¥–∞–≤–∞–π —Å–∞–º–æ —Å—ä–±–∏—Ä–∞–Ω–µ/–∏–∑–≤–∞–∂–¥–∞–Ω–µ!

**–ü—Ä–∏–º–µ—Ä–∏ —Å –í–°–ò–ß–ö–ò 4 –æ–ø–µ—Ä–∞—Ü–∏–∏:**

1Ô∏è‚É£ **–£–ú–ù–û–ñ–ï–ù–ò–ï + –°–™–ë–ò–†–ê–ù–ï:**
"–•–∞—Ä–∏ –∫—É–ø—É–≤–∞ 8 –∫—É—Ç–∏–∏ –º–∞–≥–∏—á–µ—Å–∫–∏ –±–æ–±—á–µ—Ç–∞, –≤—ä–≤ –≤—Å—è–∫–∞ –∏–º–∞ –ø–æ 12 –±–æ–±—á–µ—Ç–∞. –†–æ–Ω –º—É –¥–∞–≤–∞ –æ—â–µ 15 –±–æ–±—á–µ—Ç–∞. –ö–æ–ª–∫–æ —Å–∞ –≤—Å–∏—á–∫–∏?"
\`\`\`
–•–∞—Ä–∏: 8 –∫—É—Ç–∏–∏ x 12 = ?
–†–æ–Ω: + 15
–û–±—â–æ: ? + 15 = ?
\`\`\`

2Ô∏è‚É£ **–î–ï–õ–ï–ù–ò–ï + –ò–ó–í–ê–ñ–î–ê–ù–ï:**
"–í –≥—Ä–∞–¥–∏–Ω–∞—Ç–∞ –∏–º–∞ 56 –ª–∞–ª–µ—Ç–∞, –∑–∞—Å–∞–¥–µ–Ω–∏ –≤ 7 —Ä–µ–¥–∞. –°–ª–µ–¥ –≤—è—Ç—ä—Ä 9 –ª–∞–ª–µ—Ç–∞ —Å–∞ –∏–∑–∫–æ—Ä–µ–Ω–µ–Ω–∏. –ö–æ–ª–∫–æ —Å–∞ –æ—Å—Ç–∞–Ω–∞–ª–∏?"
\`\`\`
–õ–∞–ª–µ—Ç–∞ –≤ —Ä–µ–¥: 56 : 7 = ?
–ò–∑–∫–æ—Ä–µ–Ω–µ–Ω–∏: - 9
–û—Å—Ç–∞–Ω–∞–ª–∏: ? - 9 = ?
\`\`\`

3Ô∏è‚É£ **–£–ú–ù–û–ñ–ï–ù–ò–ï x –£–ú–ù–û–ñ–ï–ù–ò–ï:**
"–í –≥–æ—Ä–∞—Ç–∞ –∏–º–∞ 5 —Ä–µ–¥–∞ –¥—ä—Ä–≤–µ—Ç–∞, –≤ —Ä—è–¥ 8 –¥—ä—Ä–≤–µ—Ç–∞. –ù–∞ –≤—Å—è–∫–æ –¥—ä—Ä–≤–æ –ø–æ 6 –≤—Ä–∞–Ω–∏. –ö–æ–ª–∫–æ –≤—Ä–∞–Ω–∏ –æ–±—â–æ?"
\`\`\`
–î—ä—Ä–≤–µ—Ç–∞: 5 x 8 = ?
–í—Ä–∞–Ω–∏: ? x 6 = ?
\`\`\`

4Ô∏è‚É£ **–°–ú–ï–°–ï–ù–ò –û–ü–ï–†–ê–¶–ò–ò:**
"–ò—Å–∏ —á–µ—Ç–µ 4 –∫–Ω–∏–≥–∏, –≤—Å—è–∫–∞ –∏–º–∞ 25 —Å—Ç—Ä–∞–Ω–∏—Ü–∏. –ü—Ä–æ—á–µ–ª –µ 37 —Å—Ç—Ä–∞–Ω–∏—Ü–∏. –ö–æ–ª–∫–æ –æ—â–µ –º—É –æ—Å—Ç–∞–≤–∞—Ç?"
\`\`\`
–û–±—â–æ: 4 x 25 = ?
–ü—Ä–æ—á–µ—Ç–µ–Ω–∏: - 37
–û—Å—Ç–∞–≤–∞—Ç: ? - 37 = ?
\`\`\`

5Ô∏è‚É£ **–î–ï–õ–ï–ù–ò–ï + –£–ú–ù–û–ñ–ï–ù–ò–ï:**
"72 –±–æ–Ω–±–æ–Ω–∞ —Å–µ –¥–µ–ª—è—Ç –º–µ–∂–¥—É 8 –¥–µ—Ü–∞. –í—Å—è–∫–æ –¥–µ—Ç–µ –¥–∞–≤–∞ 2 –±–æ–Ω–±–æ–Ω–∞ –Ω–∞ —Ä–æ–¥–∏—Ç–µ–ª. –ö–æ–ª–∫–æ –æ—Å—Ç–∞–≤–∞—Ç –Ω–∞ –¥–µ—Ü–∞—Ç–∞?"
\`\`\`
–ù–∞ –¥–µ—Ç–µ: 72 : 8 = ?
–î–∞–≤–∞—Ç: ? - 2 = ?
\`\`\`

**–ó–ê–î–™–õ–ñ–ï–ù–ò–ï**: –†–µ–¥—É–≤–∞–π –æ–ø–µ—Ä–∞—Ü–∏–∏—Ç–µ! –ù–µ –¥–∞–≤–∞–π 3 –ø—ä—Ç–∏ –ø–æ–¥—Ä–µ–¥ —Å–∞–º–æ +/-!

üß† –ó–ê–î–™–õ–ë–û–ß–ï–ù–û –ú–ò–°–õ–ï–ù–ï –∑–∞ —Å–ª–æ–∂–Ω–∏ –∑–∞–¥–∞—á–∏:

–ó–∞ **–≥–µ–æ–º–µ—Ç—Ä–∏—è**, **–º–Ω–æ–≥–æ—Å—Ç—ä–ø–∫–æ–≤–∏** –∏–ª–∏ **–Ω–µ—è—Å–Ω–∏** –∑–∞–¥–∞—á–∏:

\`\`\`
üß† –ú–ò–°–õ–ï–ù–ï:
-----------------
ü§î –ö–∞–∫–≤–æ –∑–Ω–∞–µ–º?
   [–∏–∑–±—Ä–æ–π —Ñ–∞–∫—Ç–∏—Ç–µ]

ü§î –ö–∞–∫ –¥–∞ —Å–∏ –≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏–º?
   [–Ω–∞—Ä–∏—Å—É–≤–∞–π —Å—Ö–µ–º–∞ –∏–ª–∏ –æ–ø–∏—à–∏ –≤–∏–∑—É–∞–ª–Ω–æ]

ü§î –ö–∞–∫–≤–æ –¢–û–ß–ù–û —Ç—ä—Ä—Å–∏–º?
   [—Ñ–æ—Ä–º—É–ª–∏—Ä–∞–π –≤—ä–ø—Ä–æ—Å–∞ —è—Å–Ω–æ]

ü§î –ò–º–∞ –ª–∏ –¥–≤—É—Å–º–∏—Å–ª–∏–µ?
   [–∞–∫–æ –¥–∞, –ø–æ–ø–∏—Ç–∞–π –ò—Å–∏]

üí° –ü–õ–ê–ù:
   1. [–ø—ä—Ä–≤–∞ —Å—Ç—ä–ø–∫–∞]
   2. [–≤—Ç–æ—Ä–∞ —Å—Ç—ä–ø–∫–∞]
   3. [–ø—Ä–æ–≤–µ—Ä–∫–∞]

‚úì –ò–ó–ß–ò–°–õ–ï–ù–ò–ï:
   [–¥–µ—Ç–∞–π–ª–Ω–∏—Ç–µ —Å–º–µ—Ç–∫–∏]
-----------------
\`\`\`

–¢–æ–∑–∏ "–º–∏—Å–ª–æ–≤–µ–Ω –ø—Ä–æ—Ü–µ—Å" –ø–æ–º–∞–≥–∞ –¥–∞ —Ä–∞–∑–±–µ—Ä–µ—à –∑–∞–¥–∞—á–∞—Ç–∞ –ø—Ä–µ–¥–∏ –¥–∞ —Å–º—è—Ç–∞—à!

ü™Ñ –ú–ê–ì–ò–ß–ï–°–ö–ò –¢–†–ò–ö–û–í–ï:

- **–†–∏–º–∏**: "–û—Å–µ–º –∏ —à–µ—Å—Ç –ø—Ä–∞–≤–∏ —á–µ—Ç–∏—Ä–∏–Ω–∞–¥–µ—Å–µ—Ç" üéµ
- **–ò–≥—Ä–æ–≤–∏ –ø—Ä–∏–º–µ—Ä–∏**: "–ò–º–∞—à 15 —è–±—ä–ª–∫–∏, –¥–∞–≤–∞—à 7, –∫–æ–ª–∫–æ –æ—Å—Ç–∞–≤–∞—Ç?"
- **–ß–∏—Å–ª–æ–≤–∞ –ø—Ä–∞–≤–∞**: –°–∫–∞—á–∞–π –Ω–∞–∑–∞–¥/–Ω–∞–ø—Ä–µ–¥ –∑–∞ +/-

–ü–†–ê–í–ò–õ–ê –ó–ê –û–¢–ì–û–í–û–†–ò:

1. –û–±—Ä—ä—â–∞–π —Å–µ –ª–∏—á–Ω–æ: "–ë—Ä–∞–≤–æ, –ò—Å–∏! üòä"
2. –ü–æ–∫–∞–∂–∏ —Å–º–µ—Ç–∫–∞—Ç–∞ –≤ CODE BLOCK
3. –û–±—è—Å–Ω–µ–Ω–∏–µ –ò–ó–í–™–ù code block (3-5 —Ä–µ–¥–∞)
4. –ò–∑–ø–æ–ª–∑–≤–∞–π **–±–æ–ª–¥** –∑–∞ –≤–∞–∂–Ω–∏ —á–∏—Å–ª–∞
5. –î–∞–π –º–∞–≥–∏—á–µ—Å–∫–∏ —Ç—Ä–∏–∫ –∏–ª–∏ –∞—Å–æ—Ü–∏–∞—Ü–∏—è ü™Ñ
6. –ü—Ä–∏—Ä–æ–¥–Ω–∞ –∞–Ω–∞–ª–æ–≥–∏—è: "–ö–∞—Ç–æ –ª–∏—Å—Ç–∞ –Ω–∞ –¥—ä—Ä–≤–æ! üçÉ"
7. –ó–∞–≤—ä—Ä—à–≤–∞–π –ø–æ–∑–∏—Ç–∏–≤–Ω–æ: "–ì–æ—Ç–æ–≤ –∑–∞ —Å–ª–µ–¥–≤–∞—â–∞—Ç–∞! üåü"

–û—Ç–≥–æ–≤–∞—Ä—è–π –Ω–∞ –ë–™–õ–ì–ê–†–°–ö–ò!
`;

export default function Home() {
  const [messages, setMessages] = useState<Message[]>([
    { role: 'system', content: SYSTEM_PROMPT }
  ]);
  const [input, setInput] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState('');
  const chatContainerRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    if (chatContainerRef.current) {
      chatContainerRef.current.scrollTop = chatContainerRef.current.scrollHeight;
    }
  }, [messages]);

  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ª–æ–≥–≤–∞–Ω–µ —Å–ª–µ–¥ –≤—Å–µ–∫–∏ –æ—Ç–≥–æ–≤–æ—Ä
  useEffect(() => {
    const saveLog = async () => {
      if (messages.length <= 1) return; // –ù–µ –∑–∞–ø–∞–∑–≤–∞–π –∞–∫–æ –Ω—è–º–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä
      
      try {
        await fetch('/api/log', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ messages }),
        });
      } catch (err) {
        console.error('Auto-save error:', err);
      }
    };

    // –ó–∞–ø–∞–∑–≤–∞–π —Å–∞–º–æ –∫–æ–≥–∞—Ç–æ –∏–º–∞ –Ω–æ–≤–∏ —Å—ä–æ–±—â–µ–Ω–∏—è (–Ω–µ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ)
    if (messages.length > 1) {
      saveLog();
    }
  }, [messages.length]); // –°–∞–º–æ –∫–æ–≥–∞—Ç–æ –±—Ä–æ—è—Ç —Å–µ –ø—Ä–æ–º–µ–Ω–∏

  const sendMessage = async () => {
    if (!input.trim()) return;
    
    setError('');
    const newMessage: Message = { role: 'user', content: input };
    setMessages([...messages, newMessage]);
    setInput('');
    setIsLoading(true);

    try {
      const response = await fetch('/api/chat', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          messages: [...messages, newMessage],
        }),
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Failed to get response');
      }

      const data = await response.json();
      setMessages((prev) => [...prev, data.message]);
    } catch (err: any) {
      console.error('Error:', err);
      setError(err.message || "Couldn't connect to MathBuddy. Is LM Studio running with a model loaded?");
    } finally {
      setIsLoading(false);
    }
  };

  const handleKeyPress = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  };

  return (
    <Box
      minH="100vh"
      bgGradient="linear(to-br, purple.900, green.900)"
      py={6}
      px={4}
    >
        <Box maxW="800px" mx="auto">
          {/* Header */}
          <Box
            bg="rgba(255, 255, 255, 0.95)"
            p={6}
            borderRadius="2xl"
            shadow="2xl"
            mb={6}
            border="3px solid"
            borderColor="yellow.400"
          >
            <Text
              fontSize="5xl"
              fontWeight="bold"
              color="purple.700"
              textAlign="center"
              style={{
                textShadow: '2px 2px 4px rgba(0,0,0,0.1)'
              }}
            >
              ü™Ñ –ú–∞—Ç–ú–∞–≥ üå≤
            </Text>
          </Box>

          {/* Welcome Message */}
          <Box
            bg="rgba(255, 255, 255, 0.95)"
            p={5}
            borderRadius="xl"
            shadow="lg"
            mb={6}
            borderLeft="4px solid"
            borderColor="purple.500"
          >
            <Text fontSize="lg" color="gray.800" lineHeight="tall">
              –ó–¥—Ä–∞–≤–µ–π, –ò—Å–∫—Ä–µ–Ω! üëã –ê–∑ —Å—ä–º –ú–∞—Ç–ú–∞–≥, —Ç—É–∫ —Å—ä–º –¥–∞ –Ω–∞–ø—Ä–∞–≤—è –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞—Ç–∞ —Ç–æ–ª–∫–æ–≤–∞ –≤—ä–ª–Ω—É–≤–∞—â–∞ –∫–æ–ª–∫–æ—Ç–æ –º–∞–≥–∏—è—Ç–∞ –≤ –•–æ–≥—É–æ—Ä—Ç—Å! ü™Ñ‚ú®
              <br />
              –ü–∏—Ç–∞–π –º–µ –Ω–µ—â–∞ –∫–∞—Ç–æ <Text as="span" fontWeight="bold" color="purple.600">"–û–±—è—Å–Ω–∏ 23 - 8"</Text> –∏–ª–∏
              <Text as="span" fontWeight="bold" color="green.600"> "–î–∞–π –º–∏ —Ç–µ—Å—Ç!"</Text> üå≤
            </Text>
          </Box>
          
          {/* Error Message */}
          {error && (
            <Box
              bg="rgba(254, 226, 226, 0.95)"
              border="2px solid"
              borderColor="red.500"
              color="red.800"
              p={4}
              borderRadius="xl"
              mb={6}
              shadow="lg"
            >
              <Text fontWeight="bold">‚ö†Ô∏è {error}</Text>
            </Box>
          )}

          {/* Chat Container */}
          <Box
            ref={chatContainerRef}
            h="500px"
            overflowY="auto"
            bg="rgba(255, 255, 255, 0.95)"
            p={6}
            borderRadius="xl"
            shadow="xl"
            mb={4}
          >
            <VStack align="start" gap={4}>
              {messages.slice(1).map((msg, index) => (
                <Box
                  key={index}
                  bg={msg.role === 'user' ? 'purple.600' : 'green.600'}
                  p={4}
                  borderRadius="2xl"
                  maxW="85%"
                  alignSelf={msg.role === 'user' ? 'flex-end' : 'flex-start'}
                  shadow="lg"
                  border="3px solid"
                  borderColor={msg.role === 'user' ? 'purple.300' : 'green.300'}
                  _hover={{ transform: 'scale(1.02)', transition: 'all 0.2s' }}
                >
                  <Box
                    color="white"
                    fontSize="md"
                    lineHeight="tall"
                    fontWeight="medium"
                    css={{
                      '& p': { marginBottom: '0.5rem' },
                      '& pre': {
                        backgroundColor: 'rgba(0, 0, 0, 0.2)',
                        padding: '1rem',
                        borderRadius: '0.5rem',
                        overflowX: 'auto',
                        fontFamily: 'monospace',
                        fontSize: '1.1rem',
                        lineHeight: '1.5',
                        marginBottom: '0.5rem'
                      },
                      '& code': {
                        fontFamily: 'monospace',
                        fontSize: '1rem'
                      },
                      '& strong': {
                        fontWeight: 'bold',
                        color: '#fef08a'
                      },
                      '& ul, & ol': {
                        marginLeft: '1.5rem',
                        marginBottom: '0.5rem'
                      }
                    }}
                  >
                    {msg.role === 'assistant' && 'ü™Ñ '}
                    {msg.role === 'user' && 'üå≤ '}
                    <ReactMarkdown
                      remarkPlugins={[remarkGfm, remarkMath]}
                      rehypePlugins={[rehypeKatex]}
                    >
                      {msg.content}
                    </ReactMarkdown>
                  </Box>
                </Box>
              ))}
              {isLoading && (
                <Box alignSelf="flex-start" bg="white" p={3} borderRadius="lg">
                  <Spinner size="lg" color="purple.500" />
                  <Text color="gray.700" mt={2} fontWeight="medium">–ú–∞—Ç–ú–∞–≥ –º–∏—Å–ª–∏...</Text>
                </Box>
              )}
            </VStack>
          </Box>

          {/* Input Area */}
          <Box bg="rgba(255, 255, 255, 0.95)" p={4} borderRadius="xl" shadow="lg" mb={6}>
            <VStack gap={3}>
              <Input
                value={input}
                onChange={(e) => setInput(e.target.value)}
                placeholder="–ù–∞–ø–∏—à–∏ —Ç–≤–æ—è –≤—ä–ø—Ä–æ—Å —Ç—É–∫... ü§î"
                onKeyPress={handleKeyPress}
                size="lg"
                bg="white"
                color="gray.800"
                borderColor="gray.300"
                _hover={{ borderColor: 'purple.400' }}
                _focus={{ borderColor: 'purple.500', boxShadow: '0 0 0 1px #9333ea' }}
              />
              <Button
                onClick={sendMessage}
                disabled={isLoading}
                w="full"
                size="lg"
                bgGradient="linear(to-r, purple.500, green.500)"
                color="white"
                fontWeight="bold"
                _hover={{
                  bgGradient: 'linear(to-r, purple.600, green.600)',
                  transform: 'translateY(-2px)',
                  shadow: 'xl'
                }}
                _active={{ transform: 'translateY(0)' }}
                _disabled={{
                  opacity: 0.6,
                  cursor: 'not-allowed'
                }}
              >
                {isLoading ? 'ü™Ñ –ú–∏—Å–ª—è...' : '‚ú® –ò–∑–ø—Ä–∞—Ç–∏'}
              </Button>
            </VStack>
          </Box>
        </Box>
      </Box>
  );
}
